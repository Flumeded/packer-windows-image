---
- name: Populate configuration with ansible
  hosts: localhost
  gather_facts: false
  vars:
    timezone: Caucasus Standard Time
    windows_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38333134626330353239336133653636393663393234633664613438353134303339373235336232
      3234326536356431646436643438363162666330393834640a303265363762666334313337316239
      61356636636634646463396334396666636138383461353639666534613438646261393738323733
      3537383164636131630a363833336461393766346462633138383039353336363862303966616162
      31323462646465383736303731373537623335346335326261633563346233373936
    winkey: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35666633626335356335333132616138666365353430333865313661636239613139626237346435
      3938376461623230623564336333383634646264396131390a386564336638303065363433353437
      65636635306261396638663035313363636665616532636639333434316239653430303963353462
      3538666434333765370a393864646437383265356533666661303461373266326536303034646461
      34316334353761326235383434353934623066393861393937613132366230303432
    share_path: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39323533613463623464333764396635663439303134336138643639366262386439313736393638
      3936396464333032653066663866613637633035646566390a313835396631343032613638656563
      31613235626132623566666234303937336339666637313034376535666131353362326261326535
      3834313433333565380a616435663461643761336331666436303735353662393439353561653934
      37376163663335363161383164623563616366353135653661383863633664616635
    share_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39363238366465356237336662336632383461663266343532303163333636616264613666373066
      3133323964313930343266623734363034373332366234360a663961333564363638393664316363
      63643035323530333930363535316165373937393366333066316531363864656262303532613238
      3131393635633337300a386432623566303164643863386635356133653233643432613963386339
      33636632383266303631363037326366663133356633316463383336343865356432
    share_user: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33653561376666616632356136393031353531363930306263346635376636626430656435383161
      3464336463613939326535626464363031356238343339370a393362396561343837613237663833
      36613166663735306261663564626465633765373034656435613935363836623965356430643263
      6465363131393333320a386631633431376564313430363764373834313437326230363339663930
      3965
    ubuntu_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36663334636231346266373434373866313431306137336365376536643161366135313834343262
      3366636531386533333736333538666161646364653566640a633162646563323931393039623463
      36343636306661353038353233336636633937623366376139313731663033376630353935626630
      6263316431346433340a633361326363383130356333396333616564623063306161383230356163
      65616139316638323134653663623964373965626562376430353861633835376533333465643262
      66616664326632313834313263636435396433353464646561636234326661366364663535373964
      63373661353264656466623733643662396434396332363065373866316334616133626363393262
      65346437346632326466356264633037356265653966363438386239303039326461333236666539
      65653535346134363761393932663763643164663861656632356362356561663966303464386265
      3264373032633637613962633661393435353337323662346439
    ssh_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35313365623131653436393734393233393563383137326238326166336563363361643338616534
      3736373165313565303534393237353332366365646532630a303830363263623538393763323865
      61323066383332303366636661373661633961356436346134376336656234663062653339336438
      6531346230356432330a656233396638383537326466326531353530353130373438636139623735
      36363062306164353665633038343663323131336332366633353539356439363639346361633264
      30316439663461326264636334363538376633313730366562626261386233653066373932383835
      30663934656164663764346335643832653564636466383336346638633339333430623939636635
      38383435653337663436646130643738396138323031326163623738636363643961663664646561
      6366
  tasks:
### We need to fetch the latest MAS AIO version
### The name of cmd changes to avoid AV detection
    - name: Fetch GitHub repository contents for Microsoft Activation Scripts
      ansible.builtin.uri:
        url: https://api.github.com/repos/massgravel/Microsoft-Activation-Scripts/contents/MAS/All-In-One-Version
        method: GET
        return_content: true
        headers:
          Accept: application/vnd.github.v3+json
      register: github_content

    - name: Find MAS AIO CMD file with specific CRC32 in filename
      ansible.builtin.set_fact:
        mas_aio_cmd_file_url: "{{ item.download_url }}"
      loop: "{{ github_content.json }}"
      when: "'MAS_AIO' in item.name and item.name.endswith('.cmd')"

    - name: Download the MAS AIO CMD script from GitHub
      ansible.builtin.get_url:
        url: "{{ mas_aio_cmd_file_url }}"
        dest: "setup/MAS_AIO.cmd"
        force: true
        mode: '0755'
      when: mas_aio_cmd_file_url is defined

    - name: Decrypt the encrypted file temporarily
      ansible.builtin.copy:
        src: "variables.pkrvars.hcl.encrypted"
        dest: "variables.pkrvars.hcl"
        mode: 'preserve'
      no_log: true

    - name: Replace Windows Activation Key placeholder in autounattend.xml
      ansible.builtin.replace:
        path: "setup/autounattend.xml"
        regexp: '#Replace_Winkey'
        replace: "{{ winkey }}"


    - name: Replace timezone placeholder in autounattend.xml
      ansible.builtin.replace:
        path: "setup/autounattend.xml"
        regexp: '#Replace_Timezone'
        replace: "{{ timezone }}"

    - name: Replace password placeholder in autounattend.xml
      ansible.builtin.replace:
        path: "http/autounattend.xml"
        regexp: '#Replace_WinPassword'
        replace: "{{ windows_password }}"

    - name: Replace password placeholder in user-data file
      ansible.builtin.replace:
        path: "http/user-data"
        regexp: '#Replace_UbuntuPassword'
        replace: "{{ ubuntu_password }}"

    - name: Replace ssh key placeholder in user-data file
      ansible.builtin.replace:
        path: "http/user-data"
        regexp: '#Replace_SshKey'
        replace: "{{ ssh_key }}"

    - name: Uncomment the PowerShell script block
      ansible.builtin.replace:
        path: "setup/win_configuration.ps1"
        regexp: '^# (.*)'
        replace: '\1'

    - name: Template the share values into the file
      ansible.builtin.template:
        src: "setup/win_configuration.ps1"
        dest: "setup/win_configuration.ps1"
        mode: 'preserve'
